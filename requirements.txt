django


class TicketUpdateView(AccountAwareMixin, View):

    def get_ticket(self, request, ticket_id):
        ticket = get_object_or_404(Ticket, id=ticket_id)
        if hasattr(request.user, "role") and request.user.role == "CUSTOMER":
            if ticket.creator_id != request.user:
                return None
        elif hasattr(request.user, "role") and request.user.role == "AGENT":
            if ticket.assignee_id != request.user:
                return None
        if ticket.creator_id.account_id != request.user.account_id:
            return None
        return ticket

    def get(self, request, ticket_id):
        ticket = self.get_ticket(request, ticket_id)
        if not ticket:
            return HttpResponseForbidden("You cannot update this ticket.")
        form = TicketUpdateForm(ticket=ticket, user=request.user)
        return render(request, "update_ticket.html", {"form": form, "ticket": ticket})

    def post(self, request, ticket_id):
        ticket = self.get_ticket(request, ticket_id)
        if not ticket:
            return HttpResponseForbidden("You cannot update this ticket.")

        form = TicketUpdateForm(request.POST, ticket=ticket, user=request.user)
        if form.is_valid():
            new_status = form.cleaned_data["status"]
            description = form.cleaned_data["description"]

            allowed = form.get_allowed_transitions()
            if new_status.status not in allowed:
                return HttpResponseForbidden("Invalid ticket status transition.")

            ticket.status = new_status
            if description:
                ticket.description = description

            if hasattr(request.user, "role") and request.user.role == "AGENT":
                if ticket.assignee_id is None:
                    ticket.assignee_id = request.user
                    ticket.start_time = timezone.now()
                    ticket.deadline = ticket.start_time + ticket.priority_id.duration
                    if ticket.status.status == "TODO":
                        ticket.status = TicketStatus.objects.get(status="IN_PROGRESS")

            ticket.save(updated_by=request.user)

            return redirect("ticket_detail", ticket_id=ticket.id)

        return render(request, "update_ticket.html", {"form": form, "ticket": ticket})


class TicketHistoryView(AccountAwareMixin, View):

    def get(self, request, ticket_id):
        ticket = get_object_or_404(Ticket, id=ticket_id)
        if ticket.creator_id.account_id != request.user.account_id:
            return HttpResponseForbidden("You cannot view this ticket history.")
        history = ticket.history.all().order_by("-changed_at")
        return render(request, "ticket_history.html", {"ticket": ticket, "history": history})


class AgentTicketListView(AgentRequiredMixin, AccountAwareMixin, View):

    def get(self, request):
        tickets = self.filter_queryset_by_account(Ticket.objects.all(), user_field="creator_id")
        return render(request, "agent_ticket_list.html", {"tickets": tickets})


class CustomerTicketListView(CustomerRequiredMixin, AccountAwareMixin, View):

    def get(self, request):
        tickets = Ticket.objects.filter(creator_id=request.user)
        return render(request, "customer_ticket_list.html", {"tickets": tickets})



    path("list/", CustomerTicketListView.as_view(), name="customer_ticket_list"),

    path("<int:ticket_id>/update/", TicketUpdateView.as_view(), name="ticket_update"),
    path("<int:ticket_id>/history/", TicketHistoryView.as_view(), name="ticket_history"),
    path("<int:ticket_id>/", TicketUpdateView.as_view(), name="ticket_detail"),

    path("list/tickets/", AgentTicketListView.as_view(), name='agent_ticket_list'),
